<app-navbar></app-navbar>

<div class="trip-detail-container" *ngIf="trip && !isLoading">
  
  <div class="trip-hero">
    <div class="hero-content">
      <a routerLink="/trips" class="back-link">â† Volver a Mis Viajes</a>
      <h1>{{ trip.name }}</h1>
      <div class="hero-info">
        <span class="badge-location">ğŸ“ {{ trip.origin ? trip.origin + ' â” ' : '' }}{{ trip.destination }}</span>
        <span class="badge-date">ğŸ“… {{ trip.startDate | date:'mediumDate' }} al {{ trip.endDate | date:'mediumDate' }}</span>
      </div>
    </div>
  </div>

  <div class="map-wrapper" *ngIf="showMap" style="margin: 20px auto; max-width: 1000px; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
    <google-map 
      height="350px" 
      width="100%" 
      [center]="mapCenter" 
      [zoom]="12" 
      [options]="mapOptions">
      <map-marker *ngIf="markerPosition" [position]="markerPosition"></map-marker>
    </google-map>
  </div>

  <div class="tabs-nav">
    <button [class.active]="activeTab === 'itinerary'" (click)="setTab('itinerary')">ğŸ—“ï¸ Itinerario</button>
    <button [class.active]="activeTab === 'expenses'" (click)="setTab('expenses')">ğŸ’¸ Gastos</button>
    <button [class.active]="activeTab === 'memories'" (click)="setTab('memories')">ğŸ“¸ Recuerdos</button>
    <button [class.active]="activeTab === 'members'" (click)="setTab('members')">ğŸ‘¥ Miembros</button>
    <button [class.active]="activeTab === 'chat'" (click)="setTab('chat')">ğŸ’¬ Chat Grupo</button>
  </div>

  <div class="tab-content">

    <div *ngIf="activeTab === 'itinerary'" class="content-section">
      <div class="section-header">
        <h2>Itinerario</h2>
        <button class="btn-outline-small" (click)="openModal('activity')">+ AÃ±adir</button>
      </div>
      <div class="empty-state" *ngIf="activities.length === 0">No hay actividades programadas.</div>
      <div class="activity-list">
        <div class="activity-card" *ngFor="let act of activities">
          <div class="time-block">
            <strong>{{ act.startDatetime | date:'HH:mm' }}</strong>
            <small>{{ act.startDatetime | date:'dd MMM' }}</small>
          </div>
          <div class="act-details">
            <h4>{{ act.title }}</h4>
            <span class="act-end" *ngIf="act.endDatetime">Hasta {{ act.endDatetime | date:'HH:mm' }}</span>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="activeTab === 'expenses'" class="content-section">
      <div class="section-header">
        <h2>Control de Gastos</h2>
        <button class="btn-outline-small" (click)="openModal('expense')">+ AÃ±adir</button>
      </div>
      
      <div class="empty-state" *ngIf="expenses.length === 0">No hay gastos.</div>
      
      <div class="expense-list">
        <div class="expense-item" *ngFor="let exp of expenses">
          
          <div class="exp-header">
            <div class="exp-left">
              <div class="exp-icon">ğŸ’¸</div>
              <div class="exp-info">
                <strong>{{ exp.description }}</strong>
                <small class="paid-by">Pagado por: <span>{{ exp.paidByUserName }}</span></small>
              </div>
            </div>
            <div class="exp-amount">{{ exp.amount }} â‚¬</div>
          </div>

          <div class="exp-splits" *ngIf="exp.splits && exp.splits.length > 0">
            
            <div class="split-row" *ngFor="let split of exp.splits" [class.is-paid]="split.isPaid">
              
              <div class="custom-checkbox" (click)="togglePaid(exp.id, split)" [class.checked]="split.isPaid">
                <span *ngIf="split.isPaid">âœ“</span>
              </div>

              <span class="split-name">{{ split.userName }}</span>

              <span class="split-status" *ngIf="!split.isPaid">debe <span class="debt-amount">{{ split.amount }} â‚¬</span></span>
              <span class="split-status paid-text" *ngIf="split.isPaid">Â¡Pagado!</span>
              
            </div>

          </div>

        </div>
      </div>
    </div>

    <div *ngIf="activeTab === 'memories'" class="content-section">
      <div class="section-header">
        <h2>Ãlbum de Recuerdos</h2>
        <button class="btn-outline-small" (click)="openModal('memory')">+ Subir Foto</button>
      </div>
      <div class="empty-state" *ngIf="memories.length === 0">No hay recuerdos aÃºn.</div>
      <div class="memories-grid">
        <div class="memory-card" *ngFor="let mem of memories">
          <img *ngIf="mem.type === 'photo'" [src]="mem.mediaUrl" alt="Recuerdo">
          <div class="memory-note" *ngIf="mem.type === 'note'">ğŸ“ {{ mem.description }}</div>
          <div class="memory-caption" *ngIf="mem.type === 'photo'">{{ mem.description }}</div>
        </div>
      </div>
    </div>

    <div *ngIf="activeTab === 'members'" class="content-section">
      <div class="section-header">
        <h2>Viajeros</h2>
      </div>
      <div class="invite-container">
        <div class="search-box">
          <span class="search-icon">ğŸ”</span>
          <select [(ngModel)]="selectedFriendEmail" class="modern-select">
            <option value="" disabled selected>Elige un amigo...</option>
            <option *ngFor="let friend of myFriends" [value]="friend.email">{{ friend.userName }}</option>
          </select>
        </div>
        <button class="btn-invite-action" (click)="inviteSelectedFriend()" [disabled]="!selectedFriendEmail">+ Invitar</button>
        <button class="btn-outline-small" (click)="inviteByEmail()">Email</button>
      </div>
      <div class="members-grid-modern">
        <div class="member-card-new" *ngFor="let member of members" [class.pending-card]="member.status === 'pending'">
          <div class="card-main-info">
            <div class="avatar-wrapper">
              <div class="avatar-initials">{{ member.userName.charAt(0).toUpperCase() }}</div>
            </div>
            <div class="name-email">
              <span class="m-name">{{ member.userName }}</span>
              <span class="m-email">{{ member.role === 'owner' ? 'ğŸ‘‘ Admin' : 'ğŸ‘¤ Viajero' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="activeTab === 'chat'" class="content-section chat-section">
      <div class="chat-container">
        
        <div class="messages-list" #scrollMe [scrollTop]="scrollMe.scrollHeight">
          <div class="empty-state" *ngIf="chatMessages.length === 0">
            ğŸ‘‹ Â¡SÃ© el primero en saludar al grupo!
          </div>

          <div *ngFor="let msg of chatMessages" 
               class="message-row"
               [ngClass]="{'my-row': currentUserId === msg.user_id, 'other-row': currentUserId !== msg.user_id}">
            
            <img *ngIf="currentUserId !== msg.user_id" 
                 [src]="'https://ui-avatars.com/api/?name=' + msg.user_name + '&background=random&color=fff&size=64'" 
                 class="chat-avatar" 
                 alt="Avatar">

            <div class="message-bubble">
              <span class="msg-author-name" *ngIf="currentUserId !== msg.user_id">
                {{ msg.user_name }}
              </span>
              <div class="msg-text">{{ msg.content }}</div>
              <span class="msg-time">{{ msg.created_at | date:'HH:mm' }}</span>
            </div>
          </div>
        </div>

        <div class="chat-input-area">
          <input type="text" 
                 [(ngModel)]="newMessageText" 
                 (keyup.enter)="sendMessage()" 
                 placeholder="Escribe un mensaje..." 
                 class="modern-input-chat">
          <button class="btn-send-chat" (click)="sendMessage()">â¤</button>
        </div>

      </div>
    </div>

  </div>
</div>

<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="closeModal()">âœ•</button>

    <div *ngIf="modalType === 'activity'">
      <h2>Nueva Actividad</h2>
      <div class="form-group"><label>TÃ­tulo</label><input type="text" [(ngModel)]="newActivity.title"></div>
      <div class="form-row">
        <div class="form-group half"><label>Inicio</label><input type="datetime-local" [(ngModel)]="newActivity.start"></div>
        <div class="form-group half"><label>Fin</label><input type="datetime-local" [(ngModel)]="newActivity.end"></div>
      </div>
      <button class="btn-primary full-width" (click)="saveActivity()">Guardar</button>
    </div>

    <div *ngIf="modalType === 'expense'">
      <h2>Nuevo Gasto</h2>
      <div class="form-group"><label>Concepto</label><input type="text" [(ngModel)]="newExpense.description"></div>
      <div class="form-group"><label>Cantidad</label><input type="number" [(ngModel)]="newExpense.amount"></div>
      <button class="btn-primary full-width" (click)="saveExpense()">Guardar</button>
    </div>

    <div *ngIf="modalType === 'memory'">
      <h2>Nuevo Recuerdo</h2>
      <div class="form-group">
        <label>Tipo</label>
        <select [(ngModel)]="newMemory.type">
          <option value="photo">Foto</option>
          <option value="note">Nota</option>
        </select>
      </div>
      
      <div class="form-group" *ngIf="newMemory.type === 'photo'">
        <label>Subir Foto</label>
        <input type="file" (change)="onFileSelected($event)" accept="image/*" class="custom-file-input">
        <div class="image-preview" *ngIf="newMemory.url">
          <img [src]="newMemory.url" alt="PrevisualizaciÃ³n" style="max-height: 200px; margin-top: 10px;">
        </div>
      </div>

      <div class="form-group">
        <label>DescripciÃ³n</label>
        <textarea [(ngModel)]="newMemory.description"></textarea>
      </div>
      <button class="btn-primary full-width" (click)="saveMemory()">Guardar</button>
    </div>

  </div>
</div>

<app-footer></app-footer>