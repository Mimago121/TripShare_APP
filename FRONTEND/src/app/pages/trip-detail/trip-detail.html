<app-navbar></app-navbar>

<div class="trip-page-layout" *ngIf="trip && !isLoading">
  
  <div class="trip-main-column">
    
    <div class="trip-hero-modern">
      <div class="hero-top-row">
        <a routerLink="/trips" class="btn-back-pill"><span>â†</span> Mis Viajes</a>
      </div>

      <h1>{{ trip.name }}</h1>
      
      <div class="hero-info-modern">
        <span class="badge-location">ğŸ“ {{ trip.origin ? trip.origin + ' â” ' : '' }}{{ trip.destination }}</span>
        <span class="badge-date">ğŸ“… {{ trip.startDate | date:'dd MMM' }} - {{ trip.endDate | date:'dd MMM yyyy' }}</span>
      </div>

      <div class="quick-stats-panel">
        <div class="stat-item" (click)="setTab('expenses')">
          <span class="stat-icon">ğŸ’¸</span>
          <div class="stat-text"><span class="stat-value">{{ totalExpenses }} â‚¬</span><span class="stat-label">Gastos</span></div>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item" (click)="setTab('itinerary')">
          <span class="stat-icon">ğŸ—“ï¸</span>
          <div class="stat-text"><span class="stat-value">{{ activities.length }}</span><span class="stat-label">Planes</span></div>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item" (click)="setTab('memories')">
          <span class="stat-icon">ğŸ“¸</span>
          <div class="stat-text"><span class="stat-value">{{ memories.length }}</span><span class="stat-label">Fotos</span></div>
        </div>
      </div>
    </div>

    <div class="modern-tabs-nav">
      <button [class.active]="activeTab === 'itinerary'" (click)="setTab('itinerary')"><span class="tab-icon">ğŸ—“ï¸</span> Itinerario</button>
      <button [class.active]="activeTab === 'expenses'" (click)="setTab('expenses')"><span class="tab-icon">ğŸ’¸</span> Gastos</button>
      <button [class.active]="activeTab === 'memories'" (click)="setTab('memories')"><span class="tab-icon">ğŸ“¸</span> Recuerdos</button>
      <button [class.active]="activeTab === 'chat'" (click)="setTab('chat')"><span class="tab-icon">ğŸ’¬</span> Chat Grupal</button>
    </div>

    <div class="map-wrapper" *ngIf="showMap && activeTab === 'itinerary'">
      <google-map height="350px" width="100%" [center]="mapCenter" [zoom]="13" [options]="mapOptions">
        <map-directions-renderer *ngIf="directionsResult" [directions]="directionsResult"></map-directions-renderer>
        <ng-container *ngIf="!directionsResult">
          <map-marker *ngFor="let pos of activityMarkers" [position]="pos"></map-marker>
          <map-marker *ngIf="activityMarkers.length === 0 && markerPosition" [position]="markerPosition"></map-marker>
        </ng-container>
      </google-map>
    </div>

    <div class="tab-content">
      
      <div *ngIf="activeTab === 'itinerary'" class="content-section fade-in">
        <div class="agenda-wrapper">
          <div class="agenda-header">
            <div class="time-col-header">GMT+1</div>
            <div class="day-col-header" *ngFor="let day of tripDays">
              <span class="day-name">{{ day.dateObj | date:'EEEE' }}</span>
              <span class="day-number">{{ day.dateObj | date:'dd MMM' }}</span>
            </div>
          </div>
          <div class="agenda-body">
            <div class="time-col">
              <div class="time-slot" *ngFor="let h of hours"><span class="time-label">{{ h }}:00</span></div>
            </div>
            <div class="day-col" *ngFor="let day of tripDays">
              <div class="grid-cell" *ngFor="let h of hours" (click)="openModal('activity', day.date, h)"><span class="hover-plus">+</span></div>
              <div class="current-time-indicator" *ngIf="day.date === todayString" [style.top]="currentTimePx"><div class="time-dot"></div><div class="time-line"></div></div>
              <div class="agenda-activity" *ngFor="let act of day.activities" [ngStyle]="getActivityStyle(act)" (click)="openModal('activity', day.date)">
                <div class="act-inner">
                  <div class="act-time-small">{{ act.startDatetime | date:'HH:mm' }}</div>
                  <strong>{{ act.title }}</strong>
                  <div class="act-loc-small" *ngIf="act.location">ğŸ“ {{ act.location }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="activeTab === 'expenses'" class="content-section fade-in">
        <div class="section-header">
          <h2>Control de Gastos</h2>
          <button class="btn-primary-small" (click)="openModal('expense')">+ AÃ±adir Gasto</button>
        </div>
        <div class="empty-state" *ngIf="expenses.length === 0">
          <span class="empty-icon">ğŸ’°</span><p>No hay gastos registrados.</p>
        </div>
        <div class="expense-list">
          <div class="expense-item" *ngFor="let exp of expenses">
            <div class="exp-header">
              <div class="exp-main-info">
                <div class="exp-icon">ğŸ’¸</div>
                <div class="exp-text-block">
                  <strong class="exp-title">{{ exp.description }}</strong>
                  <div class="paid-by-badge">
                    Pagado por: <span>{{ exp.paidByUserName }}</span>
                  </div>
                </div>
              </div>
              <div class="exp-amount-box">{{ exp.amount }} â‚¬</div>
            </div>

            <div class="exp-splits" *ngIf="exp.splits && exp.splits.length > 0">
              <div class="split-row" *ngFor="let split of exp.splits" [class.is-paid]="split.isPaid">
                <div class="custom-checkbox" (click)="togglePaid(exp.id, split)" [class.checked]="split.isPaid">
                  <span *ngIf="split.isPaid">âœ“</span>
                </div>
                <span class="split-name">{{ split.userName }}</span>
                <span class="split-status" *ngIf="!split.isPaid">debe <span class="debt-amount">{{ split.amount }} â‚¬</span></span>
                <span class="split-status paid-text" *ngIf="split.isPaid">Â¡Pagado!</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="activeTab === 'memories'" class="content-section fade-in">
        <div class="section-header">
          <h2>Ãlbum de Recuerdos</h2>
          <button class="btn-primary-small" (click)="openModal('memory')">+ Subir Foto</button>
        </div>
        <div class="empty-state" *ngIf="memories.length === 0">
          <span class="empty-icon">ğŸ“·</span><p>Sube la primera foto del viaje.</p>
        </div>
        <div class="memories-grid" *ngIf="memories.length > 0">
          <div class="memory-card" *ngFor="let mem of memories">
            <img *ngIf="mem.type === 'photo'" [src]="mem.mediaUrl" alt="Recuerdo">
            <div class="memory-note" *ngIf="mem.type === 'note'">ğŸ“ {{ mem.description }}</div>
            <div class="memory-caption" *ngIf="mem.type === 'photo' && mem.description">{{ mem.description }}</div>
          </div>
        </div>
      </div>

      <div *ngIf="activeTab === 'chat'" class="content-section chat-section fade-in">
        <div class="chat-container">
          <div class="messages-list" #scrollMe [scrollTop]="scrollMe.scrollHeight">
            <div class="empty-state" *ngIf="chatMessages.length === 0">
              <span class="empty-icon">ğŸ‘‹</span><p>Â¡SÃ© el primero en saludar al grupo!</p>
            </div>
            <div *ngFor="let msg of chatMessages" class="message-row" [ngClass]="{'my-row': currentUserId === msg.user_id, 'other-row': currentUserId !== msg.user_id}">
              <img *ngIf="currentUserId !== msg.user_id" [src]="'https://ui-avatars.com/api/?name=' + msg.user_name + '&background=random&color=fff&size=64'" class="chat-avatar" alt="Avatar">
              <div class="message-bubble">
                <span class="msg-author-name" *ngIf="currentUserId !== msg.user_id">{{ msg.user_name }}</span>
                <div class="msg-text">{{ msg.content }}</div>
                <span class="msg-time">{{ msg.created_at | date:'HH:mm' }}</span>
              </div>
            </div>
          </div>
          <div class="chat-input-area">
            <input type="text" [(ngModel)]="newMessageText" (keyup.enter)="sendMessage()" placeholder="Escribe un mensaje..." class="modern-input-chat">
            <button class="btn-send-chat" (click)="sendMessage()">â¤</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <aside class="trip-sidebar fade-in">
    <div class="sidebar-header">
      <h3>ğŸ‘¥ CompaÃ±eros</h3>
    </div>
    <div class="sidebar-members-list">
      <div class="sidebar-member-item" *ngFor="let member of members" [class.pending-card]="member.status === 'pending'">
        <img [src]="'https://ui-avatars.com/api/?name=' + member.userName + '&background=random&color=fff&size=50'" class="sidebar-avatar-img" alt="Avatar">
        <div class="sidebar-member-info">
          <span class="sidebar-m-name">{{ member.userName }}</span>
          <span class="sidebar-m-role">{{ member.role === 'owner' ? 'ğŸ‘‘ Organizador' : 'ğŸ‘¤ Viajero' }}</span>
          <span class="sidebar-pending-badge" *ngIf="member.status === 'pending'">Pendiente</span>
        </div>
        
        <button class="btn-remove-member" 
                *ngIf="isOwner && member.id !== currentUserId" 
                (click)="openDeleteModal(member)" 
                title="Eliminar del viaje">
          ğŸ—‘ï¸
        </button>
      </div>
    </div>
    
    <ng-container *ngIf="isOwner">
      <hr class="sidebar-divider">
      <div class="sidebar-invite-section">
        <h4>Invitar a alguien</h4>
        <button class="btn-invite-friends-modal" (click)="openModal('invite-friends')">â• Invitar Amigos</button>
        <div class="or-divider">o por email</div>
        <div class="invite-email-box">
          <input type="email" [(ngModel)]="emailInviteInput" placeholder="ejemplo@email.com" class="sidebar-input">
          <button class="btn-email-send" (click)="inviteByEmail()" [disabled]="!emailInviteInput">â¤</button>
        </div>
        <div class="custom-error-banner" *ngIf="errorMessage && modalType === ''" style="margin-top: 10px; font-size: 0.8rem; padding: 8px;">
          <span class="error-text">{{ errorMessage }}</span>
        </div>
      </div>
    </ng-container>

    <hr class="sidebar-divider">
    <button class="btn-leave-trip-sidebar" (click)="openLeaveModal()">
      ğŸšª Abandonar Viaje
    </button>

  </aside>

</div>

<div class="modal-overlay" *ngIf="showModal">
  <div class="modal-content">
    <button class="close-btn" style="z-index: 10;" (click)="closeModal()">âœ•</button>

    <h2 style="margin-top: 0;" *ngIf="modalType === 'activity'">AÃ±adir Plan</h2>
    <h2 style="margin-top: 0;" *ngIf="modalType === 'expense'">Nuevo Gasto</h2>
    <h2 style="margin-top: 0;" *ngIf="modalType === 'memory'">Nuevo Recuerdo</h2>
    <h2 style="margin-top: 0;" *ngIf="modalType === 'invite-friends'">Invitar Amigos</h2>
    
    <h2 style="margin-top: 0; color: #dc2626;" *ngIf="modalType === 'delete-member'">Â¿Eliminar Viajero?</h2>
    <h2 style="margin-top: 0; color: #dc2626;" *ngIf="modalType === 'leave-trip'">Â¿Salir del grupo?</h2>

    <div class="custom-error-banner" *ngIf="errorMessage && modalType !== 'invite-friends' && modalType !== 'delete-member' && modalType !== 'leave-trip'">
      <span class="error-icon">âš ï¸</span><span class="error-text">{{ errorMessage }}</span>
    </div>

    <div *ngIf="modalType === 'leave-trip'">
        <p style="font-size: 1rem; color: var(--text-main); margin-bottom: 20px; line-height: 1.5;">
            {{ leaveModalMessage }}
        </p>
        
        <div class="custom-error-banner" *ngIf="errorMessage">
            <span class="error-icon">âš ï¸</span><span class="error-text">{{ errorMessage }}</span>
        </div>

        <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 10px;">
            <button class="btn-invite-action" style="flex: 1; border-color: #ccc; color: #666;" (click)="closeModal()">Cancelar</button>
            <button class="btn-danger" style="flex: 1;" (click)="confirmLeaveTrip()">
              {{ isOwner && members.length == 1 ? 'Borrar Viaje' : 'SÃ­, Salir' }}
            </button>
        </div>
    </div>

    <div *ngIf="modalType === 'delete-member'">
        <p style="font-size: 1rem; color: var(--text-main); margin-bottom: 20px; line-height: 1.5;">
            EstÃ¡s a punto de eliminar a <strong>{{ memberToDelete?.userName }}</strong> de este viaje.<br>
            <span style="font-size: 0.85rem; color: #666;">Esta acciÃ³n no se puede deshacer.</span>
        </p>
        
        <div class="custom-error-banner" *ngIf="errorMessage">
            <span class="error-icon">âš ï¸</span><span class="error-text">{{ errorMessage }}</span>
        </div>

        <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 10px;">
            <button class="btn-invite-action" style="flex: 1; border-color: #ccc; color: #666;" (click)="closeModal()">Cancelar</button>
            <button class="btn-danger" style="flex: 1;" (click)="confirmDeleteMember()">Eliminar</button>
        </div>
    </div>

    <div *ngIf="modalType === 'invite-friends'">
      <div class="empty-state" *ngIf="availableFriends.length === 0" style="padding: 30px 10px;">
        <p>Â¡No tienes mÃ¡s amigos disponibles para invitar!</p>
        <small>Agrega mÃ¡s desde la secciÃ³n "Social".</small>
      </div>
      <div class="invite-friends-list" *ngIf="availableFriends.length > 0">
        <div class="friend-invite-row" *ngFor="let friend of availableFriends">
          <img [src]="friend.avatarUrl || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" class="mini-avatar">
          <span class="friend-name">{{ friend.userName }}</span>
          <button class="btn-invite-action" (click)="inviteFriend(friend)">Invitar</button>
        </div>
      </div>
    </div>

    <div *ngIf="modalType === 'activity'">
      <p style="color: var(--text-secondary); margin-top: -10px; margin-bottom: 20px;">Para el <strong>{{ newActivity.selectedDate | date:'fullDate' }}</strong></p>
      
      <div class="form-group">
        <label>Â¿A dÃ³nde vamos?</label>
        <input type="text" [(ngModel)]="newActivity.location" #locationInput class="modern-input-chat" placeholder="Ej: Museo del Prado, Madrid">
      </div>
      
      <div class="form-group"><label>TÃ­tulo / Notas (Opcional)</label><input type="text" [(ngModel)]="newActivity.title" maxlength="50"></div>
      <div class="form-row"><div class="form-group half"><label>Hora Inicio</label><input type="time" [(ngModel)]="newActivity.startTime"></div><div class="form-group half"><label>Hora Fin (Opcional)</label><input type="time" [(ngModel)]="newActivity.endTime"></div></div>
      <button class="btn-primary full-width" (click)="saveActivity()">Guardar Plan</button>
    </div>

    <div *ngIf="modalType === 'expense'">
      <div class="form-group"><label>Concepto</label><input type="text" [(ngModel)]="newExpense.description" maxlength="50"></div>
      <div class="form-group"><label>Cantidad (â‚¬)</label><input type="number" [(ngModel)]="newExpense.amount" min="1"></div>
      <button class="btn-primary full-width" (click)="saveExpense()">Guardar</button>
    </div>

    <div *ngIf="modalType === 'memory'">
      <div class="form-group"><label>Tipo</label><select [(ngModel)]="newMemory.type"><option value="photo">Foto</option><option value="note">Nota</option></select></div>
      <div class="form-group" *ngIf="newMemory.type === 'photo'"><label>Subir Foto</label><input type="file" (change)="onFileSelected($event)" accept="image/*" class="custom-file-input"><div class="image-preview" *ngIf="newMemory.url"><img [src]="newMemory.url" style="max-height: 200px; margin-top: 10px; border-radius: 8px;"></div></div>
      <div class="form-group"><label>DescripciÃ³n</label><textarea [(ngModel)]="newMemory.description" maxlength="200"></textarea></div>
      <button class="btn-primary full-width" (click)="saveMemory()">Guardar</button>
    </div>

  </div>
</div>

<app-footer></app-footer>